{"yaml":"name: SAR Automation for Wires\nenabled: true\ntriggers:\n  - type: manual\nsteps:\n  - name: detect-amount-over-10k\n    type: elasticsearch.esql.query\n    with:\n      query: >\n        FROM fraud-workshop*\n        | WHERE event.amount >= 10000 AND (wire.inbound.bank_name IS NOT NULL OR wire.outbound.bank_name IS NOT NULL)\n        | GROK account.address \"%{GREEDYDATA:account.address}, %{WORD:account.city}, %{WORD:account.state} %{NUMBER:account.zip}$\"\n        | DISSECT account.name \"%{account.first_name} %{account.last_name}\"\n        | RENAME wire.inbound.bank_name AS bank_name | RENAME wire.outbound.bank_name AS bank_name | RENAME wire.inbound.routing_number AS routing_number | RENAME wire.outbound.routing_number AS routing_number | RENAME wire.direction AS direction\n        | STATS SARs = COUNT(*) BY event.amount, account.event, account.address, account.city, account.first_name, account.last_name, account.state, account.zip, account.type, account.telephone_number, bank_name, routing_number, direction\n        | SORT event.amount DESC | LIMIT 10\n  - name: loop_over_columns\n    type: foreach\n    foreach: \"{{steps.detect-amount-over-10k.output.values}}\"\n    steps:\n      - name: log_to_elasticsearch\n        type: elasticsearch.index\n        with:\n          index: \"sar-reports\"\n          id: \"{{ execution.id }}-{{ foreach.index }}\"\n          document:\n            timestamp: \"{{ execution.startedAt }}\"\n            total_dollar_amount: \"${{ foreach.item[1] }}\"\n            activity_description: \"Account had {{ foreach.item[2] }} amount exceeding SAR threshold.\"\n            activity_type: \"{{ foreach.item[13] }} {{ foreach.item[2] }} in excess of $10,000\"\n            financial_institution_address: \"123 Money St.\"\n            financial_institution_city: \"${{ foreach.item[4] }}\"\n            financial_institution_ein: \"${{ foreach.item[12] }}\"\n            financial_institution_name: \"${{ foreach.item[11] }}\"\n            financial_institution_state: \"TX\"\n            financial_institution_zip: \"77072\"\n            report_date: \"{{ execution.startedAt }}\"\n            suspect_address: \"${{ foreach.item[3] }}\"\n            suspect_city: \"${{ foreach.item[4] }}\"\n            suspect_first_name: \"${{ foreach.item[5] }}\"\n            suspect_last_name: \"${{ foreach.item[6] }}\"\n            suspect_phone: \"${{ foreach.item[10] }}\"\n            suspect_state: \"${{ foreach.item[7] }}\"\n            suspect_zip: \"${{ foreach.item[8] }}\"\n            suspicious_activity_date: \"{{ execution.startedAt }}\""}
